<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Viewer • Happy Dose</title>
<style>
  :root { --green:#104B39; --orange:#F26A1B; --bg:#FAFAFA; }
  * { box-sizing:border-box }
  body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0f2a22;}
  header { background:linear-gradient(135deg,var(--green),#0f4233); color:#fff; padding:16px; }
  .wrap { max-width:1100px; margin:0 auto; padding:0 12px; display:flex; align-items:center; gap:12px; }
  h1 { font-size:18px; margin:0; font-weight:700;}
  .spacer { flex:1; }
  .btn { border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block }
  .btn.print { background:#fff; color:var(--green); }
  .btn.download { background:var(--orange); color:#fff; }
  .viewer { height:calc(100vh - 64px); }
  iframe, embed { width:100%; height:100%; border:0; background:#fff; }
  .fallback { max-width:1100px; margin:0 auto; padding:16px 12px; line-height:1.6 }
  a.link { color:var(--orange); font-weight:700; }
  ul.links { margin:10px 0 0 16px; }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 id="title">Viewer</h1>
      <div class="spacer"></div>
      <button class="btn print" id="printBtn">Print</button>
      <a class="btn download" id="downloadBtn" href="#" download>Download</a>
    </div>
  </header>
  <div class="viewer" id="viewer"></div>

<script>
  // Files that actually exist in your repo root
  const allowed = new Set([
    'Mug-Scramble-Printable-Guide.pdf',
    'mug-scramble-print.pdf',
    'mug-scramble-master.html'
  ]);

  // Map old/mistyped names to the real one
  const aliases = new Map([
    ['Mug-Scramble-Master-Guide.pdf', 'Mug-Scramble-Printable-Guide.pdf'],
    ['Mug_Scramble_Master_Guide.pdf', 'Mug-Scramble-Printable-Guide.pdf']
  ]);

  const params = new URLSearchParams(location.search);
  const raw = params.get('file') || '';
  const cleaned = raw.replace(/[^a-zA-Z0-9._-]/g,''); // preserve case/.-_
  const file = aliases.get(cleaned) || cleaned;

  const titleEl = document.getElementById('title');
  const v = document.getElementById('viewer');
  const printBtn = document.getElementById('printBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  function listChoices(msg) {
    const links = Array.from(allowed)
      .map(f => `<li><a class="link" href="viewer.html?file=${encodeURIComponent(f)}">${f}</a></li>`)
      .join('');
    v.innerHTML = `<div class="fallback">
      <p>${msg}</p>
      <ul class="links">${links}</ul>
    </div>`;
    titleEl.textContent = 'Viewer';
    downloadBtn.href = '#';
    printBtn.disabled = true;
  }

  async function exists(path) {
    try { const res = await fetch(path, { method:'HEAD', cache:'no-store' }); return res.ok; }
    catch { return false; }
  }

  (async () => {
    if (!file || !allowed.has(file)) {
      return listChoices(`“${cleaned || '(no file specified)'}” isn’t allowed or doesn’t exist.`);
    }

    if (!(await exists(file))) {
      return listChoices(`File not found at “${file}”. Pick one of these:`);
    }

    titleEl.textContent = `Viewing: ${file}`;
    downloadBtn.href = file;
    downloadBtn.setAttribute('download', file.split('/').pop());

    const isPDF = /\.pdf$/i.test(file);
    const el = document.createElement(isPDF ? 'embed' : 'iframe');
    el.src = file + (isPDF ? '#view=FitH' : '');
    el.type = isPDF ? 'application/pdf' : 'text/html';
    el.id = 'contentFrame';
    v.innerHTML = '';
    v.appendChild(el);

    printBtn.disabled = false;
    printBtn.addEventListener('click', () => {
      const f = document.getElementById('contentFrame');
      try { (f.contentWindow || f).print(); }
      catch { window.open(file, '_blank', 'noopener'); }
    });

    // Optional: auto-print with ?print=1
    if (params.get('print') === '1') {
      el.addEventListener('load', () => {
        setTimeout(() => { try { (el.contentWindow || el).print(); } catch {} }, 200);
      });
    }
  })();
</script>
</body>
</html>
