<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Viewer • Happy Dose</title>
<style>
  :root { --green:#104B39; --orange:#F26A1B; --bg:#FAFAFA; }
  * { box-sizing:border-box }
  body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0f2a22;}
  header { background:linear-gradient(135deg,var(--green),#0f4233); color:#fff; padding:16px; }
  .wrap { max-width:1100px; margin:0 auto; padding:0 12px; display:flex; align-items:center; gap:12px; }
  h1 { font-size:18px; margin:0; font-weight:700;}
  .spacer { flex:1; }
  .btn { border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block }
  .btn.print { background:#fff; color:var(--green); }
  .btn.download { background:var(--orange); color:#fff; }
  .viewer { height:calc(100vh - 64px); }
  iframe { width:100%; height:100%; border:0; background:#fff; }
  .fallback { padding:16px; }
  a.link { color:var(--orange); font-weight:700; }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 id="title">Viewer</h1>
      <div class="spacer"></div>
      <button class="btn print" id="printBtn">Print</button>
      <a class="btn download" id="downloadBtn" href="#" download>Download</a>
    </div>
  </header>
  <div class="viewer" id="viewer"></div>

<script>
  // Example usage:
  // viewer.html?file=Mug-Scramble-Master-Guide.pdf
  // viewer.html?file=docs/Mug-Scramble-Master-Guide.pdf
  const params = new URLSearchParams(location.search);
  let raw = params.get('file') || '';
  try { raw = decodeURIComponent(raw); } catch(e) {}

  // Normalize (strip leading slashes, collapse //)
  const normalize = p => (p || '').replace(/^\/+/, '').replace(/\/{2,}/g, '/');
  const passed = normalize(raw);
  const base = passed.split('/').pop();   // filename only

  // Minimal allow-list (protects from arbitrary paths but allows /docs/)
  const allow = new Set([
    'mug-scramble-master.html',
    'mug-scramble-print.html',
    'Mug-Scramble-Master-Guide.pdf',
    'Mug-Scramble-Print.pdf',
    'docs/Mug-Scramble-Master-Guide.pdf',
  ]);

  const titleEl = document.getElementById('title');
  const v = document.getElementById('viewer');
  const printBtn = document.getElementById('printBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  function setFallback(msg) {
    const hint = passed || '(no file specified)';
    v.innerHTML = `<div class="fallback">
      <p>${msg || "Couldn’t load that file."}</p>
      <p>Direct link: <a class="link" href="${passed || '#'}" target="_blank" rel="noopener">${hint}</a></p>
      <p>Allowed files:<br>${[...allow].map(x=>`• ${x}`).join('<br>')}</p>
    </div>`;
    printBtn.disabled = true;
    downloadBtn.href = '#';
  }

  if (!passed) {
    setFallback('No file specified.');
  } else {
    // Build candidate paths to try in order
    const candidates = [];
    if (allow.has(passed)) candidates.push(passed);
    // If user passed bare filename and /docs entry is allow-listed, try that too
    if (base && allow.has('docs/' + base)) candidates.push('docs/' + base);
    // Also try just the basename if they passed a path
    if (base && allow.has(base) && base !== passed) candidates.push(base);

    // Deduplicate
    const tried = new Set();
    const unique = candidates.filter(p => !tried.has(p) && (tried.add(p), true));

    // If nothing matched allow-list, bail
    if (unique.length === 0) {
      setFallback('That file is not in the allow-list.');
    } else {
      (async () => {
        // Resolve first candidate that actually exists (HEAD 200)
        let resolved = null;
        for (const p of unique) {
          try {
            const res = await fetch(p, { method: 'HEAD', cache: 'no-store' });
            if (res.ok) { resolved = p; break; }
          } catch (e) {}
        }

        if (!resolved) {
          setFallback('File not found at any of the allowed paths.');
          return;
        }

        const isPDF = /\.pdf$/i.test(resolved);
        titleEl.textContent = `Viewing: ${resolved.split('/').pop()}`;
        downloadBtn.href = resolved;
        downloadBtn.setAttribute('download', resolved.split('/').pop());

        const frame = document.createElement('iframe');
        frame.id = 'contentFrame';
        frame.src = resolved + (isPDF ? '#view=FitH' : '');
        v.innerHTML = '';
        v.appendChild(frame);

        // Print handling
        printBtn.disabled = false;
        printBtn.addEventListener('click', () => {
          if (isPDF) {
            const pf = document.createElement('iframe');
            pf.style.position='fixed'; pf.style.right='0'; pf.style.bottom='0';
            pf.style.width='0'; pf.style.height='0'; pf.style.border='0';
            pf.src = resolved + '#view=FitH';
            document.body.appendChild(pf);
            pf.onload = () => {
              try { pf.contentWindow.focus(); pf.contentWindow.print(); }
              catch(e) { window.open(resolved, '_blank', 'noopener'); }
              setTimeout(() => pf.remove(), 1500);
            };
          } else {
            try { frame.contentWindow.focus(); frame.contentWindow.print(); }
            catch(e) { window.open(resolved, '_blank', 'noopener'); }
          }
        });

        // Optional auto-print
        if (params.get('print') === '1') {
          frame.addEventListener('load', () => {
            if (isPDF) {
              const pf = document.createElement('iframe');
              pf.style.position='fixed'; pf.style.right='0'; pf.style.bottom='0';
              pf.style.width='0'; pf.style.height='0'; pf.style.border='0';
              pf.src = resolved + '#view=FitH';
              document.body.appendChild(pf);
              pf.onload = () => {
                try { pf.contentWindow.focus(); pf.contentWindow.print(); } catch(e){}
                setTimeout(() => pf.remove(), 1500);
              };
            } else {
              try { frame.contentWindow.focus(); frame.contentWindow.print(); } catch(e){}
            }
          });
        }
      })();
    }
  }
</script>
</body>
</html>
